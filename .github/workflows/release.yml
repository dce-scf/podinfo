name: Publish Helm Charts

on:
  push:
    tags:
      - '*'
    # You can also trigger on pushes to specific branches if you prefer
    # branches:
    #   - main

permissions:
  contents: write 
  
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # needed to write releases and gh-pages
    steps:
      - uses: actions/checkout@v4
        
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.16.1
          
      - name: Prepare
        id: prep
        run: |
          VERSION=sha-${GITHUB_SHA::8}
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF/refs\/tags\//}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          
      - name: Package Helm Chart
        run: |
          helm package charts/podinfo --version ${{ steps.prep.outputs.VERSION }}
          
      - name: Publish helm chart to GitHub Pages
        uses: dce-scf/podinfo/helm-gh-pages@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          charts_dir: .
          target_dir: .